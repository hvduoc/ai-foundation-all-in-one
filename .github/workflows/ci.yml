name: ci
on:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      # Cài pnpm cho runner
      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      # Cài deps nếu có lockfile
      - name: Install deps
        if: hashFiles('pnpm-lock.yaml') != ''
        run: pnpm install --frozen-lockfile=false

      # Build nếu có script "build", nếu không thì bỏ qua (job vẫn pass)
      - name: Build
        run: |
          if [ -f package.json ] && node -e "process.exit(require('./package.json').scripts?.build ? 0 : 1)"; then
            pnpm run -s build
          else
            echo "No build script — skipping"
          fi

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Install deps
        if: hashFiles('pnpm-lock.yaml') != ''
        run: pnpm install --frozen-lockfile=false

      # Test nếu có script "test", nếu không thì bỏ qua (job vẫn pass)
      - name: Run tests
        run: |
          if [ -f package.json ] && node -e "process.exit(require('./package.json').scripts?.test ? 0 : 1)"; then
            pnpm -s test
          else
            echo "No tests defined — skipping"
          fi
